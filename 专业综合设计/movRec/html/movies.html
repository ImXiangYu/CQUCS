<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”µå½±æœç´¢ - ç”µå½±æ¨è</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <a href="index.html">ç”µå½±æ¨è</a>
            </div>
            <div class="nav-menu">
                <a href="index.html" class="nav-link">é¦–é¡µ</a>
                <a href="recommendations.html" class="nav-link">æ¨è</a>
                <a href="movies.html" class="nav-link active">ç”µå½±æœç´¢</a>
                <div class="nav-user" id="navUser">
                    <span class="guest-mode" id="guestMode">æ¸¸å®¢æ¨¡å¼</span>
                    <a href="login.html" class="btn-login" id="btnLogin">ç™»å½•</a>
                    <a href="register.html" class="btn-register" id="btnRegister">æ³¨å†Œ</a>
                    <div class="user-menu" id="userMenu" style="display: none;">
                        <span class="username" id="username"></span>
			<a href="#" class="btn-logout" id="btnLogout" style="color: #000000; font-weight: bold;">é€€å‡º</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <div class="section">
                <h2 class="section-title">ç”µå½±æœç´¢</h2>
                <div class="filter-bar">
                    <div class="genre-buttons-container">
                        <span class="genre-label">ç±»å‹ç­›é€‰ï¼š</span>
                        <div class="genre-buttons" id="genreButtons">
                            <button class="genre-btn active" data-genre="">å…¨éƒ¨ç±»å‹</button>
                        </div>
                    </div>
                    <div class="search-box-container">
                        <div class="search-row">
                            <input type="text" id="searchKeyword" class="search-input" placeholder="æœç´¢ç”µå½±åç§°...">
                            <input type="text" id="searchDirector" class="search-input" placeholder="æœç´¢å¯¼æ¼”...">
                            <input type="text" id="searchActor" class="search-input" placeholder="æœç´¢æ¼”å‘˜...">
                            <input type="text" id="searchPlot" class="search-input" placeholder="æœç´¢ç®€ä»‹...">
                            <button id="searchBtn" class="btn-search">æœç´¢</button>
                        </div>
                    </div>
                </div>
                <div class="movie-grid" id="movieList">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
                <div class="pagination" id="pagination"></div>
            </div>
        </div>
    </main>

    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/cookie.js"></script>
    <script>
        let currentPage = 1;
        let selectedGenres = []; // æ”¹ä¸ºæ•°ç»„æ”¯æŒå¤šé€‰
        let currentSearchParams = {
            keyword: '',
            director: '',
            actor: '',
            plot: '',
            genres: []
        };

        // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ·æ–°ï¼ˆè¯„åˆ†æ›´æ–°åï¼‰
        function checkRatingUpdate() {
            const ratingUpdated = localStorage.getItem('ratingUpdated');
            if (ratingUpdated) {
                const updateTime = parseInt(ratingUpdated);
                const now = Date.now();
                // å¦‚æœæ ‡è®°æ˜¯30ç§’å†…è®¾ç½®çš„ï¼Œåˆ·æ–°é¡µé¢
                if (now - updateTime < 30000) {
                    localStorage.removeItem('ratingUpdated');
                    window.location.reload();
                    return true;
                } else {
                    // è¶…è¿‡30ç§’çš„æ ‡è®°æ¸…é™¤
                    localStorage.removeItem('ratingUpdated');
                }
            }
            return false;
        }

        // å¤„ç†æµè§ˆå™¨åé€€/å‰è¿›æŒ‰é’®ï¼ˆpageshowäº‹ä»¶ï¼‰
        window.addEventListener('pageshow', (event) => {
            // event.persisted ä¸º true è¡¨ç¤ºé¡µé¢æ˜¯ä»ç¼“å­˜ä¸­æ¢å¤çš„ï¼ˆå¦‚æµè§ˆå™¨åé€€ï¼‰
            if (event.persisted) {
                // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ·æ–°
                checkRatingUpdate();
            }
        });

        document.addEventListener('DOMContentLoaded', async () => {
            // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ·æ–°ï¼ˆè¯„åˆ†æ›´æ–°åï¼‰
            if (checkRatingUpdate()) {
                return; // å¦‚æœåˆ·æ–°äº†ï¼Œä¸ç»§ç»­æ‰§è¡Œ
            }
            
            await loadGenres();
            await loadMovies();
            
            const searchBtn = document.getElementById('searchBtn');
            const searchKeyword = document.getElementById('searchKeyword');
            const searchDirector = document.getElementById('searchDirector');
            const searchActor = document.getElementById('searchActor');
            const searchPlot = document.getElementById('searchPlot');
            
            if (searchBtn) {
                searchBtn.addEventListener('click', handleSearch);
            }
            
            // ä¸ºæ‰€æœ‰æœç´¢æ¡†ç»‘å®šå›è½¦äº‹ä»¶
            [searchKeyword, searchDirector, searchActor, searchPlot].forEach(input => {
                if (input) {
                    input.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            handleSearch();
                        }
                    });
                }
            });
            
            // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–ï¼ˆä»è¯¦æƒ…é¡µè¿”å›æ—¶æ£€æŸ¥ï¼‰
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    // é¡µé¢å˜ä¸ºå¯è§æ—¶æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ·æ–°
                    checkRatingUpdate();
                }
            });
        });

        async function loadGenres() {
            const genreButtons = document.getElementById('genreButtons');
            if (!genreButtons) return;
            
            try {
                const data = await movieAPI.getGenres();
                // åªå–å‰10ä¸ªç±»å‹
                const genres = data.genres.slice(0, 10);
                
                genres.forEach(genre => {
                    const btn = document.createElement('button');
                    btn.className = 'genre-btn';
                    btn.textContent = genre;
                    btn.dataset.genre = genre;
                    btn.addEventListener('click', () => toggleGenre(genre, btn));
                    genreButtons.appendChild(btn);
                });
            } catch (error) {
                console.error('åŠ è½½ç±»å‹å¤±è´¥:', error);
                // å¦‚æœAPIå¤±è´¥ï¼Œä½¿ç”¨ç¡¬ç¼–ç çš„å‰10ä¸ªç±»å‹
                const hardcodedGenres = ['Musical', 'War', 'Crime', 'Romance', 'Fantasy', 'Drama', 'Music', 'Sci-Fi', 'Action', 'Comedy', 'Biography', 'Family', 'Horror', 'Short', 'Documentary', 'Film-Noir', 'Animation', 'Adventure', 'News', 'Mystery', 'Sport', 'History', 'Thriller', 'Western'];
                hardcodedGenres.forEach(genre => {
                    const btn = document.createElement('button');
                    btn.className = 'genre-btn';
                    btn.textContent = genre;
                    btn.dataset.genre = genre;
                    btn.addEventListener('click', () => toggleGenre(genre, btn));
                    genreButtons.appendChild(btn);
                });
            }
        }

        function toggleGenre(genre, btn) {
            if (genre === '') {
                // ç‚¹å‡»"å…¨éƒ¨ç±»å‹"æ—¶ï¼Œæ¸…é™¤æ‰€æœ‰é€‰æ‹©
                selectedGenres = [];
                document.querySelectorAll('.genre-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            } else {
                // åˆ‡æ¢å…¶ä»–ç±»å‹
                const allBtn = document.querySelector('.genre-btn[data-genre=""]');
                if (allBtn) allBtn.classList.remove('active');
                
                if (btn.classList.contains('active')) {
                    btn.classList.remove('active');
                    selectedGenres = selectedGenres.filter(g => g !== genre);
                } else {
                    btn.classList.add('active');
                    selectedGenres.push(genre);
                }
                
                // å¦‚æœæ²¡æœ‰ä»»ä½•ç±»å‹è¢«é€‰ä¸­ï¼Œæ¿€æ´»"å…¨éƒ¨ç±»å‹"
                if (selectedGenres.length === 0) {
                    const allBtn = document.querySelector('.genre-btn[data-genre=""]');
                    if (allBtn) allBtn.classList.add('active');
                }
            }
            
            // ç±»å‹ç­›é€‰æ”¹å˜æ—¶ï¼Œæ›´æ–°æœç´¢å‚æ•°å¹¶é‡æ–°æœç´¢
            currentSearchParams.genres = selectedGenres;
            currentPage = 1;
            loadMovies();
        }

        async function loadMovies() {
            const container = document.getElementById('movieList');
            if (!container) return;
            
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            
            try {
                let data;
                // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•æœç´¢æ¡ä»¶
                const hasSearch = currentSearchParams.keyword || currentSearchParams.director || 
                                 currentSearchParams.actor || currentSearchParams.plot || 
                                 selectedGenres.length > 0;
                
                if (hasSearch) {
                    // æœç´¢æ¨¡å¼ - è”åˆæœç´¢
                    const searchParams = {
                        keyword: currentSearchParams.keyword,
                        director: currentSearchParams.director,
                        actor: currentSearchParams.actor,
                        plot: currentSearchParams.plot,
                        genres: selectedGenres
                    };
                    
                    console.log(`æœç´¢æ¨¡å¼ - æœç´¢å‚æ•°:`, searchParams);
                    data = await movieAPI.search(searchParams, currentPage, 20);
                    console.log(`æœç´¢è¿”å› ${data.results ? data.results.length : 0} éƒ¨ç”µå½±ï¼Œæ€»æ•°: ${data.count}`);
                } else {
                    // åˆ—è¡¨æ¨¡å¼ï¼Œæ”¯æŒå¤šç±»å‹ä¸¥æ ¼ç­›é€‰
                    if (selectedGenres.length > 0) {
                        console.log(`åˆ—è¡¨æ¨¡å¼ - ç±»å‹ç­›é€‰: ${selectedGenres.join(', ')}`);
                        // å¤šç±»å‹ä¸¥æ ¼ç­›é€‰ï¼šéœ€è¦è·å–æ‰€æœ‰æ•°æ®æ¥ç­›é€‰ï¼Œä½†åç«¯åªè¿”å›å½“å‰é¡µ
                        // æ‰€ä»¥æˆ‘ä»¬éœ€è¦å¤šæ¬¡è¯·æ±‚æˆ–ä¸€æ¬¡æ€§è·å–æ‰€æœ‰æ•°æ®
                        // ä¸ºäº†æ€§èƒ½ï¼Œå…ˆè·å–ç¬¬ä¸€é¡µçœ‹æ€»æ•°ï¼Œç„¶åæ ¹æ®æ€»æ•°å†³å®šç­–ç•¥
                        const firstPageData = await movieAPI.getList(1, 20, '');
                        const totalMovies = firstPageData.count;
                        
                        // å¦‚æœæ€»æ•°ä¸å¤§ï¼Œå¯ä»¥è·å–æ‰€æœ‰æ•°æ®ç­›é€‰
                        if (totalMovies <= 1000) {
                            // è·å–æ‰€æœ‰æ•°æ®ï¼ˆåˆ†å¤šæ¬¡è¯·æ±‚ï¼‰
                            let allMovies = [];
                            const pagesNeeded = Math.ceil(totalMovies / 20);
                            for (let p = 1; p <= pagesNeeded; p++) {
                                const pageData = await movieAPI.getList(p, 20, '');
                                allMovies = allMovies.concat(pageData.results);
                            }
                            
                            // ä¸¥æ ¼ç­›é€‰
                            const filtered = allMovies.filter(movie => {
                                const movieGenres = Array.isArray(movie.genres) ? movie.genres : [];
                                const movieGenresLower = movieGenres.map(g => String(g).toLowerCase());
                                return selectedGenres.every(selected => 
                                    movieGenresLower.includes(selected.toLowerCase())
                                );
                            });
                            
                            data = {
                                results: filtered,
                                count: filtered.length,
                                page_size: 20
                            };
                            console.log(`ä¸¥æ ¼ç±»å‹ç­›é€‰æ‰¾åˆ° ${data.count} éƒ¨ç”µå½±`);
                            
                            // åˆ†é¡µ
                            const start = (currentPage - 1) * 20;
                            const end = start + 20;
                            data.results = data.results.slice(start, end);
                        } else {
                            // å¦‚æœæ€»æ•°å¤ªå¤§ï¼Œåªè·å–å½“å‰é¡µï¼ˆæ— æ³•ä¸¥æ ¼ç­›é€‰æ‰€æœ‰æ•°æ®ï¼‰
                            data = await movieAPI.getList(currentPage, 20, '');
                            // å‰ç«¯è¿‡æ»¤å½“å‰é¡µ
                            data.results = data.results.filter(movie => {
                                const movieGenres = Array.isArray(movie.genres) ? movie.genres : [];
                                const movieGenresLower = movieGenres.map(g => String(g).toLowerCase());
                                return selectedGenres.every(selected => 
                                    movieGenresLower.includes(selected.toLowerCase())
                                );
                            });
                            data.count = data.results.length;
                        }
                    } else {
                        data = await movieAPI.getList(currentPage, 20, '');
                    }
                }
                
                // ä¿å­˜æ€»æ•°åˆ°å®¹å™¨ï¼Œä¾›è·³è½¬åŠŸèƒ½ä½¿ç”¨
                if (container) {
                    container.dataset.total = data.count;
                }
                
                displayMovies(container, data.results);
                displayPagination(data.count, data.page_size || 20);
            } catch (error) {
                console.error('åŠ è½½ç”µå½±å¤±è´¥:', error);
                container.innerHTML = '<div class="loading">åŠ è½½å¤±è´¥ï¼š' + error.message + '</div>';
            }
        }

        function displayMovies(container, movies) {
            if (!movies || movies.length === 0) {
                container.innerHTML = '<div class="loading">æš‚æ— ç”µå½±</div>';
                return;
            }
            
            container.innerHTML = movies.map(movie => {
                const movieId = movie.movieId || movie._id;
                const title = movie.title || 'æœªçŸ¥ç”µå½±';
                const genres = Array.isArray(movie.genres) ? movie.genres.join(' / ') : '';
                const plot = movie.plot || '';
                const year = movie.year || '';
                // è·å–è¯„åˆ†ï¼Œå¯èƒ½æ¥è‡ªratingã€avgæˆ–scoreå­—æ®µ
                let rating = null;
                let ratingCount = 0;
                if (movie.rating && movie.rating > 0) {
                    rating = movie.rating;
                } else if (movie.avg && movie.avg > 0) {
                    rating = movie.avg;
                    ratingCount = movie.rating_count || 0;
                } else if (movie.score && movie.score > 0) {
                    rating = movie.score;
                }
                
                // ä¼˜å…ˆä½¿ç”¨CSVä¸­çš„poster_urlï¼ˆå›¾ç‰‡ç½‘å€ï¼‰ï¼Œå¦‚æœç½‘ç»œå›¾ç‰‡åŠ è½½å¤±è´¥åˆ™ä½¿ç”¨æœ¬åœ°poster
                let posterUrl = '';
                let fallbackUrl = '';
                
                if (movie.poster_url && movie.poster_url.trim()) {
                    posterUrl = movie.poster_url.trim();
                }
                
                // è®¾ç½®æœ¬åœ°å›¾ç‰‡ä½œä¸ºå¤‡ç”¨
                if (movie.poster_local) {
                    fallbackUrl = `/${movie.poster_local}`;
                } else if (movieId) {
                    // å°è¯•ä½¿ç”¨movieIdæŸ¥æ‰¾æµ·æŠ¥ï¼ˆdataç›®å½•ï¼‰
                    fallbackUrl = `/data/reco_artifacts_2026-01-16/poster/${movieId}.jpg`;
                }
                
                // å¦‚æœç½‘ç»œå›¾ç‰‡å­˜åœ¨ï¼Œä½¿ç”¨ç½‘ç»œå›¾ç‰‡ï¼Œå¤±è´¥æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°æœ¬åœ°å›¾ç‰‡
                const posterHtml = posterUrl 
                    ? `<img src="${posterUrl}" alt="${title}" onerror="console.error('ç½‘ç»œå›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œåˆ‡æ¢åˆ°æœ¬åœ°å›¾ç‰‡'); this.onerror=null; this.src='${fallbackUrl || ''}'; if (!this.src || this.src === window.location.href) { this.parentElement.innerHTML='<div class=\\'placeholder\\'><div class=\\'placeholder-icon\\'>ğŸ¬</div><div>${title}</div></div>'; }">`
                    : (fallbackUrl 
                        ? `<img src="${fallbackUrl}" alt="${title}" onerror="this.parentElement.innerHTML='<div class=\\'placeholder\\'><div class=\\'placeholder-icon\\'>ğŸ¬</div><div>${title}</div></div>'">`
                        : `<div class="placeholder"><div class="placeholder-icon">ğŸ¬</div><div>${title}</div></div>`);
                
                return `
                    <div class="movie-card" onclick="goToMovieDetail(${movieId})">
                        <div class="movie-poster">
                            ${posterHtml}
                        </div>
                        <div class="movie-info">
                            <div class="movie-title" title="${title}">${title}${year ? ` (${year})` : ''}</div>
                            <div class="movie-genres">${genres}</div>
                            ${plot ? `<div class="movie-plot">${plot}</div>` : ''}
                            <div class="movie-rating">
                                ${rating !== null && rating > 0 ? `
                                    <span class="star">â˜…</span>
                                    <span>${rating.toFixed(1)}</span>
                                    ${ratingCount > 0 ? `<span style="font-size: 12px; color: #999; margin-left: 5px;">(${ratingCount}äººè¯„ä»·)</span>` : ''}
                                ` : `
                                    <span style="font-size: 13px; color: #999; font-style: italic;">è¿˜æ²¡æœ‰è¯„åˆ†ç­‰ä½ æ¥</span>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function displayPagination(total, pageSize) {
            const pagination = document.getElementById('pagination');
            if (!pagination) return;
            
            const totalPages = Math.ceil(total / pageSize);
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let html = '';
            // ä¸Šä¸€é¡µæŒ‰é’®
            html += `<button class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(${currentPage - 1})">ä¸Šä¸€é¡µ</button>`;
            
            // é¡µç æŒ‰é’®ï¼ˆæ˜¾ç¤ºå½“å‰é¡µå‰åå„2é¡µï¼‰
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    html += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    html += `<button class="pagination-btn" disabled>...</button>`;
                }
            }
            
            // ä¸‹ä¸€é¡µæŒ‰é’®
            html += `<button class="pagination-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="changePage(${currentPage + 1})">ä¸‹ä¸€é¡µ</button>`;
            
            // è·³è½¬è¾“å…¥æ¡†
            html += `<div class="pagination-jump">
                <span>é€‰æ‹©é¡µæ•°ï¼š</span>
                <input type="number" id="pageJumpInput" min="1" max="${totalPages}" value="${currentPage}" style="width: 60px; padding: 5px; margin: 0 5px; border: 1px solid #ddd; border-radius: 4px;">
                <button class="pagination-btn" onclick="jumpToPage()">ç¡®å®š</button>
            </div>`;
            
            pagination.innerHTML = html;
            
            // ç»‘å®šè¾“å…¥æ¡†å›è½¦äº‹ä»¶
            const pageInput = document.getElementById('pageJumpInput');
            if (pageInput) {
                pageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        jumpToPage();
                    }
                });
            }
        }

        function jumpToPage() {
            const input = document.getElementById('pageJumpInput');
            if (!input) return;
            
            const targetPage = parseInt(input.value);
            if (isNaN(targetPage) || targetPage < 1) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é¡µç ');
                return;
            }
            
            // è·å–æ€»é¡µæ•°ï¼ˆä»å½“å‰æ˜¾ç¤ºçš„æ•°æ®è®¡ç®—ï¼‰
            const container = document.getElementById('movieList');
            const totalMovies = parseInt(container?.dataset.total || 0);
            const pageSize = 20;
            const totalPages = Math.ceil(totalMovies / pageSize);
            
            if (targetPage > totalPages) {
                alert(`æœ€å¤§é¡µç ä¸º ${totalPages}`);
                return;
            }
            
            changePage(targetPage);
        }

        function changePage(page) {
            currentPage = page;
            loadMovies();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function handleSearch() {
            const searchKeyword = document.getElementById('searchKeyword');
            const searchDirector = document.getElementById('searchDirector');
            const searchActor = document.getElementById('searchActor');
            const searchPlot = document.getElementById('searchPlot');
            
            // æ›´æ–°æœç´¢å‚æ•°
            currentSearchParams = {
                keyword: searchKeyword ? searchKeyword.value.trim() : '',
                director: searchDirector ? searchDirector.value.trim() : '',
                actor: searchActor ? searchActor.value.trim() : '',
                plot: searchPlot ? searchPlot.value.trim() : '',
                genres: selectedGenres  // ç±»å‹ç­›é€‰ä¹Ÿä½œä¸ºæœç´¢æ¡ä»¶
            };
            
            currentPage = 1;
            
            console.log(`handleSearch - æœç´¢å‚æ•°:`, currentSearchParams);
            loadMovies();
        }

        function goToMovieDetail(movieId) {
            if (guestMode.isGuest()) {
                guestMode.addView(movieId);
            }
            window.location.href = `movie-detail.html?id=${movieId}`;
        }
    </script>
</body>
</html>

