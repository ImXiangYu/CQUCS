<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨è - ç”µå½±æ¨è</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <a href="index.html">ç”µå½±æ¨è</a>
            </div>
            <div class="nav-menu">
                <a href="index.html" class="nav-link">é¦–é¡µ</a>
                <a href="recommendations.html" class="nav-link active">æ¨è</a>
                <a href="movies.html" class="nav-link">ç”µå½±æœç´¢</a>
                <div class="nav-user" id="navUser">
                    <span class="guest-mode" id="guestMode">æ¸¸å®¢æ¨¡å¼</span>
                    <a href="login.html" class="btn-login" id="btnLogin">ç™»å½•</a>
                    <a href="register.html" class="btn-register" id="btnRegister">æ³¨å†Œ</a>
                    <div class="user-menu" id="userMenu" style="display: none;">
                        <span class="username" id="username"></span>
                        <a href="#" class="btn-logout" id="btnLogout" style="color: #000000; font-weight: bold;">é€€å‡º</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <!-- æ¸¸å®¢æ¨¡å¼æç¤º -->
            <div class="recommendation-prompt" id="guestPrompt" style="display: none;">
                <h3>ğŸ¬ ç™»å½•è·å¾—æ›´å¥½çš„æ¨èä½“éªŒ</h3>
                <p>ç™»å½•åå¯ä»¥äº«å—ä¸ªæ€§åŒ–æ¨èã€ä¿å­˜è¯„åˆ†è®°å½•ç­‰åŠŸèƒ½</p>
                <div class="btn-group">
                    <a href="login.html" class="btn-login">ç«‹å³ç™»å½•</a>
                    <a href="register.html" class="btn-register">å…è´¹æ³¨å†Œ</a>
                </div>
            </div>

            <!-- çƒ­é—¨æ¨èåŒºåŸŸ -->
            <div class="section" id="topRatedSection">
                <h2 class="section-title">çƒ­é—¨æ¨è</h2>
                <p class="recommendation-description" style="color: #000; font-weight: 500; margin-bottom: 20px;">åŸºäºæ‰€æœ‰ç”¨æˆ·çš„è¯„åˆ†ï¼Œä¸ºæ‚¨æ¨èæœ€å—æ¬¢è¿çš„ç”µå½±ï¼ˆå‰20éƒ¨ï¼‰</p>
                <div class="movie-grid" id="topRatedList">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>

            <!-- ä¸ªäººå–œå¥½æ¨èåŒºåŸŸ -->
            <div class="section" id="personalizedSection" style="display: none;">
                <h2 class="section-title">ä¸ªäººå–œå¥½æ¨è</h2>
                <p class="recommendation-description" style="color: #000; font-weight: 500; margin-bottom: 20px;">æ ¹æ®æ‚¨çš„å¥½è¯„ç”µå½±ï¼ˆè¯„åˆ†â‰¥4åˆ†ï¼‰çš„ç›¸ä¼¼åº¦ï¼Œä¸ºæ‚¨æ¨èå¯èƒ½å–œæ¬¢çš„ç”µå½±</p>
                <div class="movie-grid" id="personalizedList">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
                <!-- åˆ†é¡µæ§ä»¶ -->
                <div class="pagination" id="personalizedPagination" style="display: none;"></div>
            </div>
        </div>
    </main>

    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/cookie.js"></script>
    <script>
        // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ·æ–°ï¼ˆè¯„åˆ†æ›´æ–°åï¼‰
        function checkRatingUpdate() {
            const ratingUpdated = localStorage.getItem('ratingUpdated');
            if (ratingUpdated) {
                const updateTime = parseInt(ratingUpdated);
                const now = Date.now();
                // å¦‚æœæ ‡è®°æ˜¯30ç§’å†…è®¾ç½®çš„ï¼Œåˆ·æ–°é¡µé¢
                if (now - updateTime < 30000) {
                    localStorage.removeItem('ratingUpdated');
                    window.location.reload();
                    return true;
                } else {
                    // è¶…è¿‡30ç§’çš„æ ‡è®°æ¸…é™¤
                    localStorage.removeItem('ratingUpdated');
                }
            }
            return false;
        }

        // å¤„ç†æµè§ˆå™¨åé€€/å‰è¿›æŒ‰é’®ï¼ˆpageshowäº‹ä»¶ï¼‰
        window.addEventListener('pageshow', (event) => {
            // event.persisted ä¸º true è¡¨ç¤ºé¡µé¢æ˜¯ä»ç¼“å­˜ä¸­æ¢å¤çš„ï¼ˆå¦‚æµè§ˆå™¨åé€€ï¼‰
            if (event.persisted) {
                // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ·æ–°
                checkRatingUpdate();
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ·æ–°ï¼ˆè¯„åˆ†æ›´æ–°åï¼‰
            if (checkRatingUpdate()) {
                return; // å¦‚æœåˆ·æ–°äº†ï¼Œä¸ç»§ç»­æ‰§è¡Œ
            }
            
            updateUI();
            // åŒæ—¶åŠ è½½çƒ­é—¨æ¨èå’Œä¸ªäººå–œå¥½æ¨è
            loadTopRatedRecommendations();
            if (auth.isAuthenticated()) {
                loadPersonalizedRecommendations();
            }
            
            // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–ï¼ˆä»è¯¦æƒ…é¡µè¿”å›æ—¶æ£€æŸ¥ï¼‰
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    // é¡µé¢å˜ä¸ºå¯è§æ—¶æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ·æ–°
                    checkRatingUpdate();
                }
            });
        });

        function updateUI() {
            const isAuthenticated = auth.isAuthenticated();
            const guestPrompt = document.getElementById('guestPrompt');
            const personalizedSection = document.getElementById('personalizedSection');
            
            if (isAuthenticated) {
                if (guestPrompt) guestPrompt.style.display = 'none';
                if (personalizedSection) personalizedSection.style.display = 'block';
            } else {
                if (guestPrompt) guestPrompt.style.display = 'block';
                if (personalizedSection) personalizedSection.style.display = 'none';
            }
        }
        
        // åŠ è½½çƒ­é—¨æ¨è
        async function loadTopRatedRecommendations() {
            const container = document.getElementById('topRatedList');
            if (!container) return;
            
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            
            try {
                const data = await recommendationAPI.getTopRated(20);
                if (data && data.results) {
                    displayRecommendations(container, data.results, 'top-rated');
                } else {
                    container.innerHTML = '<div class="loading">æš‚æ— æ¨è</div>';
                }
            } catch (error) {
                container.innerHTML = '<div class="loading">åŠ è½½å¤±è´¥ï¼š' + error.message + '</div>';
            }
        }
        
        // åŠ è½½ä¸ªäººå–œå¥½æ¨è
        async function loadPersonalizedRecommendations() {
            const container = document.getElementById('personalizedList');
            if (!container) return;
            
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            
            try {
                const data = await recommendationAPI.getItemBased(100); // è·å–æ›´å¤šä»¥ä¾¿åˆ†é¡µ
                
                if (data && data.results) {
                    if (data.results.length === 0) {
                        container.innerHTML = '<div class="loading">æš‚æ— æ¨èã€‚è¯·å…ˆä¸ºä¸€äº›ç”µå½±è¯„åˆ†ï¼ˆâ‰¥4åˆ†ï¼‰ä»¥è·å¾—ä¸ªæ€§åŒ–æ¨èã€‚</div>';
                        document.getElementById('personalizedPagination').style.display = 'none';
                    } else {
                        personalizedAllResults = data.results;
                        const pageSize = 20;
                        const pageResults = personalizedAllResults.slice(0, pageSize);
                        displayRecommendations(container, pageResults, 'personalized');
                        
                        // æ˜¾ç¤ºåˆ†é¡µæ§ä»¶
                        if (personalizedAllResults.length > pageSize) {
                            displayPersonalizedPagination(1, Math.ceil(personalizedAllResults.length / pageSize));
                        } else {
                            document.getElementById('personalizedPagination').style.display = 'none';
                        }
                    }
                } else {
                    container.innerHTML = '<div class="loading">æš‚æ— æ¨è</div>';
                    document.getElementById('personalizedPagination').style.display = 'none';
                }
            } catch (error) {
                if (error.message.includes('è®¤è¯') || error.message.includes('Token')) {
                    container.innerHTML = '<div class="loading">è¯·å…ˆç™»å½•ä»¥ä½¿ç”¨ä¸ªæ€§åŒ–æ¨èåŠŸèƒ½</div>';
                } else {
                    container.innerHTML = '<div class="loading">åŠ è½½å¤±è´¥ï¼š' + error.message + '</div>';
                }
            }
        }

        let personalizedCurrentPage = 1;
        let personalizedAllResults = [];
        
        function displayRecommendations(container, movies, type) {
            if (!movies || movies.length === 0) {
                container.innerHTML = '<div class="loading">æš‚æ— æ¨è</div>';
                return;
            }
            
            container.innerHTML = movies.map(movie => {
                const movieId = movie.movieId || movie._id;
                const title = movie.title || 'æœªçŸ¥ç”µå½±';
                const genres = Array.isArray(movie.genres) ? movie.genres.join(' / ') : '';
                
                // ä¿®å¤è¯„åˆ†æ˜¾ç¤ºbugï¼šåªæ˜¾ç¤ºå®é™…è¯„åˆ†ï¼Œä¸æ˜¾ç¤ºæ¨èåˆ†æ•°
                // scoreæ˜¯æ¨èç®—æ³•çš„ç›¸ä¼¼åº¦åˆ†æ•°ï¼Œä¸æ˜¯ç”µå½±è¯„åˆ†
                // åº”è¯¥ä»movieå¯¹è±¡ä¸­è·å–å®é™…çš„ratingå­—æ®µï¼Œæˆ–è€…ä»åç«¯è·å–ç”µå½±è¯¦æƒ…
                let rating = null;
                let ratingCount = 0;
                
                // å¦‚æœæœ‰ratingå­—æ®µä¸”å¤§äº0ï¼Œæ‰æ˜¾ç¤º
                if (movie.rating && movie.rating > 0) {
                    rating = movie.rating;
                } else if (movie.avg && movie.avg > 0) {
                    rating = movie.avg;
                    ratingCount = movie.rating_count || 0;
                }
                // ä¸æ˜¾ç¤ºscoreå­—æ®µï¼Œå› ä¸ºé‚£æ˜¯æ¨èç®—æ³•çš„ç›¸ä¼¼åº¦åˆ†æ•°ï¼Œä¸æ˜¯ç”µå½±è¯„åˆ†
                
                const plot = movie.plot || '';
                const year = movie.year || '';
                
                // ä¼˜å…ˆä½¿ç”¨CSVä¸­çš„poster_urlï¼ˆå›¾ç‰‡ç½‘å€ï¼‰ï¼Œå¦‚æœç½‘ç»œå›¾ç‰‡åŠ è½½å¤±è´¥åˆ™ä½¿ç”¨æœ¬åœ°poster
                let posterUrl = '';
                let fallbackUrl = '';
                
                if (movie.poster_url && movie.poster_url.trim()) {
                    posterUrl = movie.poster_url.trim();
                }
                
                // è®¾ç½®æœ¬åœ°å›¾ç‰‡ä½œä¸ºå¤‡ç”¨
                if (movie.poster_local) {
                    fallbackUrl = `/${movie.poster_local}`;
                } else if (movieId) {
                    // å°è¯•ä½¿ç”¨movieIdæŸ¥æ‰¾æµ·æŠ¥ï¼ˆdataç›®å½•ï¼‰
                    fallbackUrl = `/data/reco_artifacts_2026-01-16/poster/${movieId}.jpg`;
                }
                
                // å¦‚æœç½‘ç»œå›¾ç‰‡å­˜åœ¨ï¼Œä½¿ç”¨ç½‘ç»œå›¾ç‰‡ï¼Œå¤±è´¥æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°æœ¬åœ°å›¾ç‰‡
                const posterHtml = posterUrl 
                    ? `<img src="${posterUrl}" alt="${title}" onerror="console.error('ç½‘ç»œå›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œåˆ‡æ¢åˆ°æœ¬åœ°å›¾ç‰‡'); this.onerror=null; this.src='${fallbackUrl || ''}'; if (!this.src || this.src === window.location.href) { this.parentElement.innerHTML='<div class=\\'placeholder\\'><div class=\\'placeholder-icon\\'>ğŸ¬</div><div>${title}</div></div>'; }">`
                    : (fallbackUrl 
                        ? `<img src="${fallbackUrl}" alt="${title}" onerror="this.parentElement.innerHTML='<div class=\\'placeholder\\'><div class=\\'placeholder-icon\\'>ğŸ¬</div><div>${title}</div></div>'">`
                        : `<div class="placeholder"><div class="placeholder-icon">ğŸ¬</div><div>${title}</div></div>`);
                
                const reason = movie.reason || '';
                
                return `
                    <div class="movie-card" onclick="goToMovieDetail(${movieId})">
                        <div class="movie-poster">
                            ${posterHtml}
                        </div>
                        <div class="movie-info">
                            <div class="movie-title" title="${title}">${title}${year ? ` (${year})` : ''}</div>
                            <div class="movie-genres">${genres}</div>
                            ${plot ? `<div class="movie-plot">${plot}</div>` : ''}
                            <div class="movie-rating">
                                ${rating !== null && rating > 0 ? `
                                    <span class="star">â˜…</span>
                                    <span>${rating.toFixed(1)}</span>
                                    ${ratingCount > 0 ? `<span style="font-size: 12px; color: #999; margin-left: 5px;">(${ratingCount}äººè¯„ä»·)</span>` : ''}
                                ` : `
                                    <span style="font-size: 13px; color: #999; font-style: italic;">è¿˜æ²¡æœ‰è¯„åˆ†ç­‰ä½ æ¥</span>
                                `}
                            </div>
                            ${reason ? `<div class="movie-reason" style="font-size: 12px; color: #007722; margin-top: 5px; font-style: italic;">${reason}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function displayPersonalizedPagination(currentPage, totalPages) {
            const pagination = document.getElementById('personalizedPagination');
            if (!pagination) return;
            
            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }
            
            pagination.style.display = 'flex';
            personalizedCurrentPage = currentPage;
            
            let html = '';
            
            // ä¸Šä¸€é¡µæŒ‰é’®
            html += `<button class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="changePersonalizedPage(${currentPage - 1})">ä¸Šä¸€é¡µ</button>`;
            
            // é¡µç æŒ‰é’®
            const maxVisible = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
            let endPage = Math.min(totalPages, startPage + maxVisible - 1);
            
            if (endPage - startPage < maxVisible - 1) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }
            
            if (startPage > 1) {
                html += `<button class="pagination-btn" onclick="changePersonalizedPage(1)">1</button>`;
                if (startPage > 2) {
                    html += `<span class="pagination-ellipsis">...</span>`;
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="changePersonalizedPage(${i})">${i}</button>`;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    html += `<span class="pagination-ellipsis">...</span>`;
                }
                html += `<button class="pagination-btn" onclick="changePersonalizedPage(${totalPages})">${totalPages}</button>`;
            }
            
            // ä¸‹ä¸€é¡µæŒ‰é’®
            html += `<button class="pagination-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="changePersonalizedPage(${currentPage + 1})">ä¸‹ä¸€é¡µ</button>`;
            
            // è·³è½¬è¾“å…¥æ¡†
            html += `
                <div class="pagination-jump">
                    <span>è·³è½¬åˆ°</span>
                    <input type="number" id="personalizedPageJumpInput" min="1" max="${totalPages}" value="${currentPage}" style="width: 60px; padding: 5px; margin: 0 5px;">
                    <span>é¡µ</span>
                    <button class="pagination-btn" onclick="jumpToPersonalizedPage()">ç¡®å®š</button>
                </div>`;
            
            pagination.innerHTML = html;
        }
        
        function changePersonalizedPage(page) {
            const pageSize = 20;
            const start = (page - 1) * pageSize;
            const end = start + pageSize;
            const pageResults = personalizedAllResults.slice(start, end);
            
            const container = document.getElementById('personalizedList');
            displayRecommendations(container, pageResults, 'personalized');
            displayPersonalizedPagination(page, Math.ceil(personalizedAllResults.length / pageSize));
            window.scrollTo({ top: container.offsetTop - 100, behavior: 'smooth' });
        }
        
        function jumpToPersonalizedPage() {
            const input = document.getElementById('personalizedPageJumpInput');
            if (!input) return;
            
            const targetPage = parseInt(input.value);
            const totalPages = Math.ceil(personalizedAllResults.length / 20);
            
            if (isNaN(targetPage) || targetPage < 1) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é¡µç ');
                return;
            }
            
            if (targetPage > totalPages) {
                alert(`æœ€å¤§é¡µç ä¸º ${totalPages}`);
                return;
            }
            
            changePersonalizedPage(targetPage);
        }

        function goToMovieDetail(movieId) {
            if (guestMode.isGuest()) {
                guestMode.addView(movieId);
            }
            window.location.href = `movie-detail.html?id=${movieId}`;
        }
    </script>
</body>
</html>

