<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”µå½±è¯¦æƒ… - ç”µå½±æ¨è</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <a href="index.html">ç”µå½±æ¨è</a>
            </div>
            <div class="nav-menu">
                <a href="index.html" class="nav-link">é¦–é¡µ</a>
                <a href="recommendations.html" class="nav-link">æ¨è</a>
                <a href="movies.html" class="nav-link active">ç”µå½±æœç´¢</a>
                <div class="nav-user" id="navUser">
                    <span class="guest-mode" id="guestMode">æ¸¸å®¢æ¨¡å¼</span>
                    <a href="login.html" class="btn-login" id="btnLogin">ç™»å½•</a>
                    <a href="register.html" class="btn-register" id="btnRegister">æ³¨å†Œ</a>
                    <div class="user-menu" id="userMenu" style="display: none;">
                        <span class="username" id="username"></span>
                        <a href="#" class="btn-logout" id="btnLogout" style="color: #000000; font-weight: bold;">é€€å‡º</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <div class="movie-detail" id="movieDetail">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </main>

    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/cookie.js"></script>
    <script>
        let movieId = null;
        let currentRating = 0;
        let userRating = null;
        let comments = [];

        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            movieId = parseInt(urlParams.get('id'));
            
            if (!movieId) {
                document.getElementById('movieDetail').innerHTML = '<div class="loading">ç”µå½±IDæ— æ•ˆ</div>';
                return;
            }
            
            await loadMovieDetail();
            await loadRatingStats();
            await loadComments();
            
            if (auth.isAuthenticated()) {
                await loadUserRating();
            } else {
                const guestRatings = guestMode.getRatings();
                if (guestRatings[movieId]) {
                    userRating = guestRatings[movieId];
                    currentRating = userRating;
                    updateRatingDisplay();
                }
            }
            
            // æ‹¦æˆªå¯¼èˆªæ é“¾æ¥ç‚¹å‡»ï¼Œç¡®ä¿è¯„åˆ†æ›´æ–°æ ‡è®°åœ¨è·³è½¬æ—¶ç”Ÿæ•ˆ
            const navLinks = document.querySelectorAll('.nav-link, .nav-brand a');
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    // æ£€æŸ¥æ˜¯å¦æœ‰è¯„åˆ†æ›´æ–°æ ‡è®°
                    const ratingUpdated = localStorage.getItem('ratingUpdated');
                    if (ratingUpdated) {
                        const updateTime = parseInt(ratingUpdated);
                        const now = Date.now();
                        // å¦‚æœæ ‡è®°æ˜¯30ç§’å†…è®¾ç½®çš„ï¼Œæ›´æ–°æ ‡è®°æ—¶é—´ï¼Œç¡®ä¿ç›®æ ‡é¡µé¢èƒ½æ£€æµ‹åˆ°
                        if (now - updateTime < 30000) {
                            // æ›´æ–°æ ‡è®°æ—¶é—´ï¼Œç¡®ä¿ç›®æ ‡é¡µé¢èƒ½æ£€æµ‹åˆ°
                            localStorage.setItem('ratingUpdated', Date.now().toString());
                        } else {
                            // è¶…è¿‡30ç§’çš„æ ‡è®°æ¸…é™¤
                            localStorage.removeItem('ratingUpdated');
                        }
                    }
                });
            });
            
            // ç›‘å¬é¡µé¢å¸è½½äº‹ä»¶ï¼Œç¡®ä¿ç¦»å¼€è¯¦æƒ…é¡µæ—¶æ ‡è®°ä»ç„¶æœ‰æ•ˆ
            window.addEventListener('beforeunload', () => {
                const ratingUpdated = localStorage.getItem('ratingUpdated');
                if (ratingUpdated) {
                    const updateTime = parseInt(ratingUpdated);
                    const now = Date.now();
                    // å¦‚æœæ ‡è®°æ˜¯30ç§’å†…è®¾ç½®çš„ï¼Œæ›´æ–°æ ‡è®°æ—¶é—´
                    if (now - updateTime < 30000) {
                        localStorage.setItem('ratingUpdated', Date.now().toString());
                    }
                }
            });
        });

        async function loadMovieDetail() {
            try {
                console.log('æ­£åœ¨åŠ è½½ç”µå½±è¯¦æƒ…ï¼ŒmovieId:', movieId);
                const movie = await movieAPI.getDetail(movieId);
                
                if (!movie || !movie.title) {
                    throw new Error('ç”µå½±æ•°æ®ä¸å®Œæ•´');
                }
                
                console.log('æˆåŠŸåŠ è½½ç”µå½±æ•°æ®:', movie);
                
                const genres = Array.isArray(movie.genres) ? movie.genres.join(' / ') : '';
                const plot = movie.plot || movie.intro || 'æš‚æ— ç®€ä»‹';
                const year = movie.year || '';
                const directors = Array.isArray(movie.directors) ? movie.directors.join('ã€') : '';
                const actors = Array.isArray(movie.actors) ? movie.actors.join('ã€') : '';
                const writers = Array.isArray(movie.writers) ? movie.writers.join('ã€') : '';
                const time = movie.time || '';
                const release_time = movie.release_time || '';
                
                // ä¼˜å…ˆä½¿ç”¨CSVä¸­çš„poster_urlï¼ˆå›¾ç‰‡ç½‘å€ï¼‰ï¼Œå¦‚æœç½‘ç»œå›¾ç‰‡åŠ è½½å¤±è´¥åˆ™ä½¿ç”¨æœ¬åœ°poster
                let posterUrl = '';
                let fallbackUrl = '';
                
                if (movie.poster_url && movie.poster_url.trim()) {
                    posterUrl = movie.poster_url.trim();
                }
                
                // è®¾ç½®æœ¬åœ°å›¾ç‰‡ä½œä¸ºå¤‡ç”¨
                if (movie.poster_local) {
                    fallbackUrl = `/${movie.poster_local}`;
                } else if (movieId) {
                    // å°è¯•ä½¿ç”¨movieIdæŸ¥æ‰¾æµ·æŠ¥ï¼ˆdataç›®å½•ï¼‰
                    fallbackUrl = `/data/reco_artifacts_2026-01-16/poster/${movieId}.jpg`;
                }
                
                // å¦‚æœç½‘ç»œå›¾ç‰‡å­˜åœ¨ï¼Œä½¿ç”¨ç½‘ç»œå›¾ç‰‡ï¼Œå¤±è´¥æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°æœ¬åœ°å›¾ç‰‡
                const posterHtml = posterUrl 
                    ? `<img src="${posterUrl}" alt="${movie.title}" onerror="console.error('ç½‘ç»œå›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œåˆ‡æ¢åˆ°æœ¬åœ°å›¾ç‰‡'); this.onerror=null; this.src='${fallbackUrl || ''}'; if (!this.src || this.src === window.location.href) { this.parentElement.innerHTML='<div style=\\'text-align: center; padding: 40px 20px; color: #fff;\\'><div style=\\'font-size: 64px; margin-bottom: 15px;\\'>ğŸ¬</div><div>${movie.title}</div></div>'; }">`
                    : (fallbackUrl 
                        ? `<img src="${fallbackUrl}" alt="${movie.title}" onerror="this.parentElement.innerHTML='<div style=\\'text-align: center; padding: 40px 20px; color: #fff;\\'><div style=\\'font-size: 64px; margin-bottom: 15px;\\'>ğŸ¬</div><div>${movie.title}</div></div>'">`
                        : `<div style="text-align: center; padding: 40px 20px; color: #fff;"><div style="font-size: 64px; margin-bottom: 15px;">ğŸ¬</div><div>${movie.title}</div></div>`);
                
                document.getElementById('movieDetail').innerHTML = `
                    <div class="movie-detail-header">
                        <div class="movie-detail-poster">
                            ${posterHtml}
                        </div>
                        <div class="movie-detail-info">
                            <h1>${movie.title}${year ? ` (${year})` : ''}</h1>
                            <div class="genres">ç±»å‹ï¼š${genres || 'æœªçŸ¥'}</div>
                            ${time ? `<div class="movie-meta-item"><span class="movie-meta-label">æ—¶é•¿ï¼š</span>${time}</div>` : ''}
                            ${release_time ? `<div class="movie-meta-item"><span class="movie-meta-label">ä¸Šæ˜ æ—¶é—´ï¼š</span>${release_time}</div>` : ''}
                            ${directors ? `<div class="movie-meta-item"><span class="movie-meta-label">å¯¼æ¼”ï¼š</span>${directors}</div>` : ''}
                            ${writers ? `<div class="movie-meta-item"><span class="movie-meta-label">ç¼–å‰§ï¼š</span>${writers}</div>` : ''}
                            ${actors ? `<div class="movie-meta-item"><span class="movie-meta-label">ä¸»æ¼”ï¼š</span>${actors}</div>` : ''}
                            <div class="rating-section">
                                <div>å¹³å‡è¯„åˆ†ï¼š<span id="avgRating">åŠ è½½ä¸­...</span></div>
                                <div>è¯„åˆ†äººæ•°ï¼š<span id="ratingCount">åŠ è½½ä¸­...</span></div>
                            </div>
                            <div class="rating-input">
                                <div>æˆ‘çš„è¯„åˆ†ï¼š</div>
                                <div class="rating-stars" id="ratingStars">
                                    ${[1,2,3,4,5].map(i => `<span class="star" data-rating="${i}">â˜…</span>`).join('')}
                                </div>
                                <button class="btn-rate" id="btnRate" onclick="submitRating()">æäº¤è¯„åˆ†</button>
                                <span style="font-size: 12px; color: #666; margin-left: 10px;">æç¤ºï¼šæ¯ä¸ªç”µå½±åªèƒ½è¯„åˆ†ä¸€æ¬¡ï¼Œå¯ä¿®æ”¹</span>
                            </div>
                        </div>
                    </div>
                    <div class="movie-plot-full">
                        <h3>å‰§æƒ…ç®€ä»‹</h3>
                        <p>${plot}</p>
                    </div>
                    <div class="comments-section">
                        <h3>è¯„è®º (${comments.length})</h3>
                        ${auth.isAuthenticated() ? `
                            <div class="comment-form">
                                <textarea id="commentContent" placeholder="å†™ä¸‹ä½ çš„è¯„è®ºï¼ˆå¯é€‰ï¼Œè‡³å°‘5ä¸ªå­—ç¬¦ï¼‰..."></textarea>
                                <div style="margin-top: 10px;">
                                    <label>è¯„åˆ†ï¼ˆå¯é€‰ï¼‰ï¼š</label>
                                    <div class="rating-stars" id="commentRatingStars">
                                        ${[1,2,3,4,5].map(i => `<span class="star" data-rating="${i}">â˜…</span>`).join('')}
                                    </div>
                                    <span style="font-size: 12px; color: #666; margin-left: 10px;">æç¤ºï¼šå¯ä»¥åªè¯„è®ºä¸è¯„åˆ†ï¼Œæˆ–åªè¯„åˆ†ä¸è¯„è®º</span>
                                </div>
                                <button class="btn-submit" onclick="submitComment()" style="margin-top: 15px;">æäº¤</button>
                            </div>
                        ` : `
                            <div class="comment-form" style="text-align: center; padding: 30px;">
                                <p>ç™»å½•åå¯ä»¥å‘è¡¨è¯„è®º</p>
                                <a href="login.html?redirect=${encodeURIComponent(window.location.href)}" class="btn-login">ç«‹å³ç™»å½•</a>
                            </div>
                        `}
                        <div id="commentsList"></div>
                    </div>
                `;
                
                // ç»‘å®šæ˜Ÿæ˜Ÿç‚¹å‡»äº‹ä»¶
                const stars = document.querySelectorAll('#ratingStars .star');
                stars.forEach((star, index) => {
                    star.addEventListener('click', () => {
                        if (!auth.isAuthenticated() && guestMode.isGuest()) {
                            if (confirm('ç™»å½•åå¯ä»¥ä¿å­˜è¯„åˆ†è®°å½•ï¼Œæ˜¯å¦å‰å¾€ç™»å½•ï¼Ÿ')) {
                                window.location.href = `login.html?redirect=${encodeURIComponent(window.location.href)}`;
                                return;
                            }
                        }
                        currentRating = index + 1;
                        updateRatingDisplay();
                    });
                });
                
                // ç»‘å®šè¯„è®ºè¯„åˆ†æ˜Ÿæ˜Ÿ
                if (auth.isAuthenticated()) {
                    const commentStars = document.querySelectorAll('#commentRatingStars .star');
                    let commentRating = 0;
                    commentStars.forEach((star, index) => {
                        star.addEventListener('click', () => {
                            commentRating = index + 1;
                            commentStars.forEach((s, i) => {
                                if (i < commentRating) {
                                    s.classList.add('active');
                                } else {
                                    s.classList.remove('active');
                                }
                            });
                            window.commentRating = commentRating;
                        });
                    });
                }
                
                updateRatingDisplay();
                displayComments();
            } catch (error) {
                console.error('åŠ è½½ç”µå½±è¯¦æƒ…å¤±è´¥:', error);
                let errorMsg = error.message || 'æœªçŸ¥é”™è¯¯';
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯404æˆ–ç”µå½±ä¸å­˜åœ¨
                if (errorMsg.includes('404') || errorMsg.includes('ä¸å­˜åœ¨') || errorMsg.includes('not found')) {
                    errorMsg = 'ç”µå½±ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥ç”µå½±IDæ˜¯å¦æ­£ç¡®';
                } else if (errorMsg.includes('æ— æ³•è¿æ¥')) {
                    errorMsg = 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥åç«¯æ˜¯å¦å·²å¯åŠ¨';
                } else if (errorMsg.includes('æ•°æ®ä¸å®Œæ•´')) {
                    errorMsg = 'ç”µå½±æ•°æ®ä¸å®Œæ•´ï¼Œè¯·ç¨åé‡è¯•';
                }
                
                document.getElementById('movieDetail').innerHTML = `
                    <div class="error-message" style="text-align: center; padding: 40px; color: #d32f2f;">
                        <h2 style="margin-bottom: 20px;">åŠ è½½å¤±è´¥</h2>
                        <p style="font-size: 16px; margin-bottom: 20px;">${errorMsg}</p>
                        <p style="font-size: 14px; color: #666; margin-bottom: 20px;">ç”µå½±ID: ${movieId}</p>
                        <a href="index.html" style="display: inline-block; padding: 10px 20px; background: #007722; color: #fff; text-decoration: none; border-radius: 4px;">è¿”å›é¦–é¡µ</a>
                    </div>
                `;
            }
        }

        async function loadRatingStats() {
            try {
                const stats = await ratingAPI.getMovieStats(movieId);
                const avgEl = document.getElementById('avgRating');
                const countEl = document.getElementById('ratingCount');
                if (avgEl) avgEl.textContent = stats.avg ? stats.avg.toFixed(1) : 'æš‚æ— ';
                if (countEl) countEl.textContent = stats.count || 0;
            } catch (error) {
                console.error('åŠ è½½è¯„åˆ†ç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        async function loadUserRating() {
            try {
                // å…ˆä»ratingsé›†åˆè·å–è¯„åˆ†
                const ratings = await ratingAPI.getUserRatings(1, 100);
                let rating = ratings.results.find(r => r.movieId === movieId);
                
                // å¦‚æœratingsä¸­æ²¡æœ‰ï¼Œå°è¯•ä»commentsä¸­è·å–ï¼ˆè¯„è®ºä¸­å¯èƒ½åŒ…å«è¯„åˆ†ï¼‰
                if (!rating) {
                    const commentsData = await commentAPI.getMovieComments(movieId, 1, 100);
                    if (auth.isAuthenticated()) {
                        const user = auth.getCurrentUser();
                        const userComment = commentsData.results.find(c => c.userId === user.userId);
                        if (userComment && userComment.rating) {
                            userRating = userComment.rating;
                            currentRating = userRating;
                            updateRatingDisplay();
                            return;
                        }
                    }
                } else {
                    userRating = rating.rating;
                    currentRating = userRating;
                    updateRatingDisplay();
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·è¯„åˆ†å¤±è´¥:', error);
            }
        }

        async function loadComments() {
            try {
                const data = await commentAPI.getMovieComments(movieId, 1, 50);
                comments = data.results || [];
                displayComments();
            } catch (error) {
                console.error('åŠ è½½è¯„è®ºå¤±è´¥:', error);
                comments = [];
            }
        }

        function displayComments() {
            const container = document.getElementById('commentsList');
            if (!container) return;
            
            if (comments.length === 0) {
                container.innerHTML = '<div class="loading">æš‚æ— è¯„è®º</div>';
                return;
            }
            
            container.innerHTML = comments.map(comment => {
                const time = comment.timestamp ? new Date(comment.timestamp).toLocaleString('zh-CN') : '';
                const ratingHtml = comment.rating ? `
                    <div class="comment-rating">
                        <span class="star">â˜…</span>
                        <span>${comment.rating.toFixed(1)}</span>
                    </div>
                ` : '';
                
                const actionsHtml = auth.isAuthenticated() && auth.getCurrentUser() && auth.getCurrentUser().userId === comment.userId ? `
                    <div class="comment-actions">
                        <button onclick="editComment('${comment.id}')">ç¼–è¾‘</button>
                        <button onclick="deleteComment('${comment.id}')">åˆ é™¤</button>
                    </div>
                ` : '';
                
                return `
                    <div class="comment-item">
                        <div class="comment-header">
                            <div>
                                <span class="comment-author">${comment.username || 'åŒ¿åç”¨æˆ·'}</span>
                                ${ratingHtml}
                            </div>
                            <span class="comment-time">${time}</span>
                        </div>
                        <div class="comment-content">${comment.content}</div>
                        ${actionsHtml}
                    </div>
                `;
            }).join('');
        }

        function updateRatingDisplay() {
            const stars = document.querySelectorAll('#ratingStars .star');
            stars.forEach((star, index) => {
                if (index < currentRating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        async function submitRating() {
            if (currentRating === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¯„åˆ†');
                return;
            }
            
            if (!auth.isAuthenticated()) {
                if (confirm('è¯„åˆ†åŠŸèƒ½éœ€è¦ç™»å½•ï¼Œæ˜¯å¦å‰å¾€ç™»å½•é¡µé¢ï¼Ÿ')) {
                    window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.href);
                }
                return;
            }
            
            try {
                await ratingAPI.create(movieId, currentRating);
                // è®¾ç½®æ ‡è®°ï¼Œé€šçŸ¥å…¶ä»–é¡µé¢éœ€è¦åˆ·æ–°
                localStorage.setItem('ratingUpdated', Date.now().toString());
                alert('è¯„åˆ†æˆåŠŸï¼é¡µé¢å°†è‡ªåŠ¨åˆ·æ–°ä»¥æ›´æ–°å¹³å‡åˆ†ã€‚');
                // åˆ·æ–°é¡µé¢ä»¥å®æ—¶æ›´æ–°å¹³å‡åˆ†è®¡ç®—
                window.location.reload();
            } catch (error) {
                console.error('è¯„åˆ†å¤±è´¥:', error);
                if (error.message.includes('Token') || error.message.includes('è¿‡æœŸ') || error.message.includes('ç™»å½•')) {
                    if (confirm('ç™»å½•å·²è¿‡æœŸï¼Œæ˜¯å¦å‰å¾€ç™»å½•é¡µé¢ï¼Ÿ')) {
                        window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.href);
                    }
                } else {
                    alert('è¯„åˆ†å¤±è´¥ï¼š' + error.message);
                }
            }
        }

        async function submitComment() {
            if (!auth.isAuthenticated()) {
                if (confirm('è¯„è®ºåŠŸèƒ½éœ€è¦ç™»å½•ï¼Œæ˜¯å¦å‰å¾€ç™»å½•é¡µé¢ï¼Ÿ')) {
                    window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.href);
                }
                return;
            }
            
            const content = document.getElementById('commentContent').value.trim();
            const rating = window.commentRating || null;
            
            // å…è®¸åªè¯„è®ºä¸è¯„åˆ†ï¼Œæˆ–åªè¯„åˆ†ä¸è¯„è®ºï¼ˆä½†è‡³å°‘è¦æœ‰ä¸€æ ·ï¼‰
            if (!content && !rating) {
                alert('è¯·è¾“å…¥è¯„è®ºå†…å®¹æˆ–é€‰æ‹©è¯„åˆ†');
                return;
            }
            
            // å¦‚æœæœ‰è¯„è®ºå†…å®¹ï¼Œè‡³å°‘5ä¸ªå­—ç¬¦
            if (content && content.length < 5) {
                alert('è¯„è®ºå†…å®¹è‡³å°‘5ä¸ªå­—ç¬¦');
                return;
            }
            
            // å¦‚æœæ²¡æœ‰è¯„è®ºå†…å®¹ä½†æœ‰è¯„åˆ†ï¼Œä½¿ç”¨é»˜è®¤è¯„è®º
            const finalContent = content || 'ï¼ˆä»…è¯„åˆ†ï¼‰';
            
            try {
                await commentAPI.create(movieId, finalContent, rating);
                // å¦‚æœè¯„è®ºåŒ…å«è¯„åˆ†ï¼Œåˆ·æ–°é¡µé¢ä»¥å®æ—¶æ›´æ–°å¹³å‡åˆ†è®¡ç®—
                if (rating) {
                    // è®¾ç½®æ ‡è®°ï¼Œé€šçŸ¥å…¶ä»–é¡µé¢éœ€è¦åˆ·æ–°
                    localStorage.setItem('ratingUpdated', Date.now().toString());
                    alert('æ“ä½œæˆåŠŸï¼é¡µé¢å°†è‡ªåŠ¨åˆ·æ–°ä»¥æ›´æ–°å¹³å‡åˆ†ã€‚');
                    window.location.reload();
                } else {
                    // å¦‚æœåªæ˜¯è¯„è®ºæ²¡æœ‰è¯„åˆ†ï¼Œåªé‡æ–°åŠ è½½è¯„è®ºåˆ—è¡¨
                    document.getElementById('commentContent').value = '';
                    if (window.commentRating) {
                        document.querySelectorAll('#commentRatingStars .star').forEach(s => s.classList.remove('active'));
                        window.commentRating = 0;
                    }
                    await loadComments();
                    alert('æ“ä½œæˆåŠŸï¼');
                }
            } catch (error) {
                console.error('è¯„è®ºå‘è¡¨å¤±è´¥:', error);
                if (error.message.includes('Token') || error.message.includes('è¿‡æœŸ') || error.message.includes('ç™»å½•')) {
                    if (confirm('ç™»å½•å·²è¿‡æœŸï¼Œæ˜¯å¦å‰å¾€ç™»å½•é¡µé¢ï¼Ÿ')) {
                        window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.href);
                    }
                } else {
                    alert('æ“ä½œå¤±è´¥ï¼š' + error.message);
                }
            }
        }

        async function deleteComment(commentId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ')) {
                return;
            }
            
            try {
                await commentAPI.delete(commentId);
                await loadComments();
                alert('è¯„è®ºå·²åˆ é™¤');
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥ï¼š' + error.message);
            }
        }

        function editComment(commentId) {
            const comment = comments.find(c => c.id === commentId);
            if (!comment) return;
            
            const newContent = prompt('ç¼–è¾‘è¯„è®ºï¼š', comment.content);
            if (newContent && newContent.trim() && newContent !== comment.content) {
                commentAPI.update(commentId, newContent.trim(), comment.rating)
                    .then(() => {
                        loadComments();
                        alert('è¯„è®ºå·²æ›´æ–°');
                    })
                    .catch(error => {
                        alert('æ›´æ–°å¤±è´¥ï¼š' + error.message);
                    });
            }
        }
    </script>
</body>
</html>
